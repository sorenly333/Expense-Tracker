<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Food Expense Report</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f9f9f9;
        }

        h2 {
            color: #333;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            background: #fff;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #007BFF;
            color: white;
        }

        input,
        button {
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button {
            background: #007BFF;
            color: white;
            cursor: pointer;
            border: none;
        }

        button:hover {
            background: #0056b3;
        }

        .edit {
            background: #28a745;
            color: white;
        }

        .edit:hover {
            background: #1e7e34;
        }
    </style>
</head>

<body>

    <h2>Food Expense Report (Monthly Total)</h2>
    <a href="./index.html"><button>Home</button></a>
    <a href="./daily-expense.html"><button>Daily</button></a>
    <a href="./food-expense-weekly.html"><button>Food</button></a>
    <a href="./total-daily-report.html"><button>Report Daily</button></a> <br>
    <button class="edit" onclick="downloadCSV()">Download as CSV</button>

    <table id="reportTable">
        <thead>
            <tr>
                <th>Nº</th>
                <th>Month</th>
                <th>Year</th>
                <th>Monthly Total (៛)</th>
                <th>Expected Amount (៛)</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const foodData = JSON.parse(localStorage.getItem('foodExpense')) || [];
        const tbody = document.querySelector('#reportTable tbody');

        // Aggregate weekly data into monthly totals
        const monthlyTotals = {};
        foodData.forEach(row => {
            const key = row.month + '-' + row.year;
            if (!monthlyTotals[key]) monthlyTotals[key] = { total: 0 };
            monthlyTotals[key].total += Number(row.amount) || 0;
        });

        // Render table
        let no = 1;
        Object.keys(monthlyTotals).sort().forEach(key => {
            const [month, year] = key.split('-');
            const tr = document.createElement('tr');
            tr.innerHTML = `
    <td>${no++}</td>
    <td>${month}</td>
    <td>${year}</td>
    <td>${monthlyTotals[key].total}</td>
    <td>240000</td>`; // fixed expected amount per month
            tbody.appendChild(tr);
        });

        // CSV download function
        function downloadCSV() {
            if (Object.keys(monthlyTotals).length === 0) {
                alert("Cannot download, no data available!");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,Nº,Month,Year,Monthly Total,Expected Amount\n";
            let no = 1;
            Object.keys(monthlyTotals).sort().forEach(key => {
                const [month, year] = key.split('-');
                csvContent += `${no++},${month},${year},${monthlyTotals[key].total},240000\n`;
            });

            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "food_report_monthly.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>

</body>

</html>